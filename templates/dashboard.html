<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WDBX & Lylex Dashboard</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mt-4 mb-4">WDBX & Lylex Dashboard</h1>
    <p><a href="{{ url_for('view_updates') }}" class="btn btn-info mb-4">Outdated Packages</a></p>
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="vectors-tab" data-toggle="tab" href="#vectors" role="tab">Vectors</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="artifacts-tab" data-toggle="tab" href="#artifacts" role="tab">Artifacts</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="lylex-tab" data-toggle="tab" href="#lylex" role="tab">Lylex</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="chat-tab" data-toggle="tab" href="#chat" role="tab">Chat</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="scripting-tab" data-toggle="tab" href="#scripting" role="tab">Scripting</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="plugins-tab" data-toggle="tab" href="#plugins" role="tab">Plugins</a>
        </li>
    </ul>
    <div class="tab-content mt-3" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="vectors" role="tabpanel">
            <div class="form-group">
                <label>Vector (JSON array):</label>
                <textarea id="vector_input" class="form-control" rows="2">[0.1, 0.2, 0.3]</textarea>
            </div>
            <div class="form-group">
                <label>Metadata (JSON):</label>
                <textarea id="metadata_input" class="form-control" rows="2">{}</textarea>
            </div>
            <button id="store_vector_btn" class="btn btn-primary">Store Vector</button>
            <button id="search_vector_btn" class="btn btn-secondary ml-2">Search Vector</button>
            <span id="vector-spinner" class="spinner-border text-primary ml-2" role="status" style="display:none;"></span>
            <pre id="vector_result" class="mt-3"></pre>
        </div>
        <div class="tab-pane fade" id="artifacts" role="tabpanel">
            <form id="artifact_form" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Model File:</label>
                    <input type="file" name="file" class="form-control-file" required>
                </div>
                <div class="form-group">
                    <label>Metadata (JSON):</label>
                    <textarea name="metadata" id="artifact_metadata" class="form-control" rows="2">{}</textarea>
                </div>
                <button type="submit" class="btn btn-primary">Upload Artifact</button>
                <span id="artifact-spinner" class="spinner-border text-primary ml-2" role="status" style="display:none;"></span>
            </form>
            <pre id="artifact_result" class="mt-3"></pre>
            <div class="form-group mt-3">
                <label>Download Artifact ID:</label>
                <input id="artifact_id_input" class="form-control w-25 d-inline-block">
                <button id="download_artifact_btn" class="btn btn-secondary ml-2">Download Artifact</button>
            </div>
        </div>
        <div class="tab-pane fade" id="lylex" role="tabpanel">
            <div class="form-group">
                <label>Prompt:</label>
                <input id="lylex_prompt" class="form-control">
            </div>
            <div class="form-group">
                <label>Response (for storage):</label>
                <input id="lylex_response" class="form-control">
            </div>
            <div class="form-group">
                <label>Metadata (JSON):</label>
                <textarea id="lylex_meta" class="form-control" rows="2">{}</textarea>
            </div>
            <button id="lylex_store_btn" class="btn btn-primary">Store Interaction</button>
            <button id="lylex_search_btn" class="btn btn-secondary ml-2">Search Interactions</button>
            <button id="lylex_trace_btn" class="btn btn-info ml-2">Neural Backtrace</button>
            <span id="lylex-spinner" class="spinner-border text-primary ml-2" role="status" style="display:none;"></span>
            <pre id="lylex_result" class="mt-3"></pre>
        </div>
        <div class="tab-pane fade" id="chat" role="tabpanel">
            <div id="chat_window" class="border rounded p-3 mb-3" style="height:300px; overflow-y:auto; background:#f9f9f9;"></div>
            <div class="input-group mb-3">
                <input id="chat_input" type="text" class="form-control" placeholder="Type your message...">
                <div class="input-group-append">
                    <button id="chat_send_btn" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="scripting" role="tabpanel">
            <div class="row mt-3">
                <div class="col-md-6">
                    <h5>Python (Pyodide)</h5>
                    <textarea id="py_code" class="form-control" rows="8">print('Hello from Python')</textarea>
                    <button id="run_py" class="btn btn-success mt-2">Run Python</button>
                    <pre id="py_output" class="mt-2"></pre>
                </div>
                <div class="col-md-6">
                    <h5>JavaScript</h5>
                    <textarea id="js_code" class="form-control" rows="8">console.log('Hello from JS');</textarea>
                    <button id="run_js" class="btn btn-success mt-2">Run JavaScript</button>
                    <pre id="js_output" class="mt-2"></pre>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="plugins" role="tabpanel">
            <button id="refresh_plugins_btn" class="btn btn-primary mb-2">Refresh Plugins</button>
            <table class="table table-bordered">
                <thead>
                    <tr><th>Name</th><th>Version</th><th>Author</th><th>Description</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="plugins_table_body"></tbody>
            </table>
        </div>
    </div>
</div>
<script>
$(function() {
    function handleAction(button, spinner, resultEl, ajaxOpts) {
        button.prop('disabled', true);
        spinner.show();
        $.ajax(ajaxOpts)
            .done(r => resultEl.text(JSON.stringify(r, null, 2)))
            .fail((_, textStatus) => resultEl.text('Error: ' + textStatus))
            .always(() => { button.prop('disabled', false); spinner.hide(); });
    }
    $('#store_vector_btn').click(function() {
        handleAction($(this), $('#vector-spinner'), $('#vector_result'), {
            url: '/api/vector/store',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({vector: JSON.parse($('#vector_input').val()), metadata: JSON.parse($('#metadata_input').val())})
        });
    });
    $('#search_vector_btn').click(function() {
        handleAction($(this), $('#vector-spinner'), $('#vector_result'), {
            url: '/api/vector/search',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({vector: JSON.parse($('#vector_input').val()), limit:10})
        });
    });
    $('#artifact_form').submit(function(e){
        e.preventDefault();
        var form = new FormData(this);
        $('#artifact-spinner').show();
        $.ajax({
            url: '/api/artifact/store',
            method: 'POST',
            data: form,
            processData: false,
            contentType: false
        })
        .done(r => $('#artifact_result').text(JSON.stringify(r, null, 2)))
        .fail((_, textStatus) => $('#artifact_result').text('Error: ' + textStatus))
        .always(() => $('#artifact-spinner').hide());
    });
    $('#download_artifact_btn').click(function() {
        var id = $('#artifact_id_input').val();
        window.location = '/api/artifact/load/' + id;
    });
    $('#lylex_store_btn').click(function() {
        handleAction($(this), $('#lylex-spinner'), $('#lylex_result'), {
            url: '/api/lylex/store_interaction',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({prompt: $('#lylex_prompt').val(), response: $('#lylex_response').val(), metadata: JSON.parse($('#lylex_meta').val())})
        });
    });
    $('#lylex_search_btn').click(function() {
        handleAction($(this), $('#lylex-spinner'), $('#lylex_result'), {
            url: '/api/lylex/search_interactions',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({prompt: $('#lylex_prompt').val(), limit:5})
        });
    });
    $('#lylex_trace_btn').click(function() {
        handleAction($(this), $('#lylex-spinner'), $('#lylex_result'), {
            url: '/api/lylex/neural_backtrace',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({prompt: $('#lylex_prompt').val()})
        });
    });

    // Scripting runners
    let pyodideReady = loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
    $('#run_py').click(async function() {
        $('#py_output').text('Running...');
        const code = $('#py_code').val();
        try {
            const py = await pyodideReady;
            const result = await py.runPythonAsync(code);
            $('#py_output').text(result === undefined ? '' : result.toString());
        } catch (e) {
            $('#py_output').text(e);
        }
    });
    $('#run_js').click(function() {
        $('#js_output').text('Running...');
        try {
            const code = $('#js_code').val();
            const result = Function(code)();
            $('#js_output').text(result === undefined ? '' : result.toString());
        } catch (e) {
            $('#js_output').text(e);
        }
    });

    // -- Chat UI handler
    $('#chat_send_btn').click(function() {
        const prompt = $('#chat_input').val().trim();
        if (!prompt) return;
        $('#chat_input').val('');
        $('#chat_window').append('<div><strong>You:</strong> ' + prompt + '</div>');
        $('#chat_window').scrollTop($('#chat_window')[0].scrollHeight);
        $.ajax({
            url: '/api/lylex/chat',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({prompt: prompt})
        })
        .done(function(r) {
            const resp = r.response || JSON.stringify(r, null, 2);
            $('#chat_window').append('<div><strong>Bot:</strong> ' + resp + '</div>');
            $('#chat_window').scrollTop($('#chat_window')[0].scrollHeight);
        })
        .fail(function(_, textStatus) {
            $('#chat_window').append('<div class="text-danger">Error: ' + textStatus + '</div>');
            $('#chat_window').scrollTop($('#chat_window')[0].scrollHeight);
        });
    });
    $('#chat_input').keypress(function(e) {
        if (e.which === 13) {
            $('#chat_send_btn').click();
            e.preventDefault();
        }
    });

    // Plugin management handlers
    function loadPlugins(){
        const btn = $('#refresh_plugins_btn');
        btn.prop('disabled', true);
        $.ajax({ url: '/plugins/status', method: 'GET' })
        .done(r => {
            const tbody = $('#plugins_table_body').empty();
            (r.plugins || []).forEach(p => {
                const actions = [];
                if (p.enabled) {
                    actions.push(`<button class="btn btn-sm btn-warning disable-plugin-btn" data-plugin="${p.identifier}">Disable</button>`);
                } else {
                    actions.push(`<button class="btn btn-sm btn-success enable-plugin-btn" data-plugin="${p.identifier}">Enable</button>`);
                }
                actions.push(`<button class="btn btn-sm btn-info reload-plugin-btn ml-1" data-plugin="${p.identifier}">Reload</button>`);
                tbody.append(
                    `<tr>
                        <td>${p.name}</td>
                        <td>${p.version || ''}</td>
                        <td>${p.author || ''}</td>
                        <td>${p.description || ''}</td>
                        <td>${p.enabled ? 'Enabled' : 'Disabled'}</td>
                        <td>${actions.join(' ')}</td>
                    </tr>`
                );
            });
        })
        .fail((_, t) => alert('Failed to load plugins: ' + t))
        .always(() => btn.prop('disabled', false));
    }
    $('#refresh_plugins_btn').click(loadPlugins);
    $('a[data-toggle="tab"]').on('shown.bs.tab', e => { if (e.target.id === 'plugins-tab') loadPlugins(); });
    $('#plugins_table_body').on('click', '.enable-plugin-btn', function(){
        const id = $(this).data('plugin');
        $.ajax({ url: '/plugins/enable', method: 'POST', contentType: 'application/json', data: JSON.stringify({plugin: id}) })
          .done(loadPlugins)
          .fail((_,t) => alert('Enable failed: ' + t));
    });
    $('#plugins_table_body').on('click', '.disable-plugin-btn', function(){
        const id = $(this).data('plugin');
        $.ajax({ url: '/plugins/disable', method: 'POST', contentType: 'application/json', data: JSON.stringify({plugin: id}) })
          .done(loadPlugins)
          .fail((_,t) => alert('Disable failed: ' + t));
    });
    $('#plugins_table_body').on('click', '.reload-plugin-btn', function(){
        const id = $(this).data('plugin');
        $.ajax({ url: '/plugins/reload', method: 'POST', contentType: 'application/json', data: JSON.stringify({plugin: id}) })
          .done(loadPlugins)
          .fail((_,t) => alert('Reload failed: ' + t));
    });
});
</script>
</body>
</html> 